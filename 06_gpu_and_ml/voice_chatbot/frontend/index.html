<h1>wip</h1>
<div style="position: relative"></div>

<script type="module">
  import RecorderNode from "./recorder-node.js";

  const onBufferFilled = async (buffer) => {
    const blob = new Blob([buffer], { type: "audio/float32" });

    const t0 = performance.now();
    const response = await fetch("/transcribe", {
      method: "POST",
      body: blob,
      headers: { "Content-Type": "audio/float32" },
    });

    if (!response.ok) {
      throw new Error(
        "Error occurred during transcription: " + response.status
      );
    }

    // You can process the response here, e.g., convert it to JSON or text.
    const data = await response.json();
    console.log(data, performance.now() - t0);
  };

  const getNextFrameLoop = async (stream) => {
    const context = new AudioContext();
    const source = context.createMediaStreamSource(stream);

    await context.audioWorklet.addModule("processor.js");
    const recorderNode = new RecorderNode(context, onBufferFilled);

    source.connect(recorderNode);
    recorderNode.connect(context.destination);
  };

  navigator.mediaDevices
    .getUserMedia({ audio: true })
    .then(getNextFrameLoop)
    .catch((e) => {
      message.textContent = e.name + ": " + e.message;
    });
</script>
